<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>HTR Dashboard</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        .tabs { display: flex; border-bottom: 2px solid #ddd; margin-bottom: 20px; }
        .tab { padding: 10px 20px; cursor: pointer; color: #666; font-weight: 600; border-bottom: 2px solid transparent; margin-bottom: -2px; }
        .tab:hover { color: #333; background: #f9f9f9; }
        .tab.active { color: #007bff; border-bottom: 2px solid #007bff; background: white; }
        
        .badge { position: absolute; top: 5px; right: 5px; padding: 3px 6px; border-radius: 4px; font-size: 0.7em; color: white; font-weight: bold; }
        .badge-new { background: #ffc107; color: #333; }
        .badge-ready { background: #28a745; }
        
        .card-actions { display: flex; border-top: 1px solid #ddd; }
        .action-btn { flex: 1; padding: 8px 0; text-align: center; background: #f9f9f9; color: #333; text-decoration: none; font-size: 0.85em; transition: 0.2s; }
        .action-btn:hover { background: #e0e0e0; }
        .action-btn:first-child { border-right: 1px solid #ddd; }
        .action-crop:hover { color: #d39e00; }
        .action-segment:hover { color: #28a745; }
    </style>
</head>
<body class="dashboard">

<div class="container">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h1 style="margin:0">–ü—Ä–æ–µ–∫—Ç—ã</h1>
        <div style="display:flex; gap:10px;">
            <button class="btn btn-primary" onclick="openImportModal()">–ò–º–ø–æ—Ä—Ç ZIP</button>
            <button class="btn btn-success" onclick="window.location.href='/api/export_zip'">–≠–∫—Å–ø–æ—Ä—Ç</button>
            <button id="btn-delete" class="btn danger" style="display:none" onclick="deleteSelected()">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="filterTabs('all', this)">–í—Å–µ ({{ files|length }})</div>
        <div class="tab" onclick="filterTabs('crop', this)">To Crop</div>
        <div class="tab" onclick="filterTabs('segment', this)">To Segment</div>
    </div>

    <div id="drop-area">
        <p style="pointer-events:none; color:#666;">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏ —Å—é–¥–∞</p>
        <input type="file" id="fileElem" multiple accept="image/*" style="display:none">
        <div id="upload-status" style="display:none; margin-top:10px; color:#007bff; font-weight:bold;"></div>
    </div>

    <div class="file-list">
        {% for file in files %}
        <div class="file-card" data-status="{{ file.status }}">
            <div style="position:relative;">
                <!-- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –í—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ JS –≤–º–µ—Å—Ç–æ —Å–ª–æ–∂–Ω–æ–π Jinja –ª–æ–≥–∏–∫–∏ –≤ –∞—Ç—Ä–∏–±—É—Ç–µ -->
                <img src="/data/images/{{ file.name }}" class="thumb" 
                     onclick="openEditor('{{ file.name }}', '{{ file.status }}')"
                     loading="lazy" style="cursor:pointer">
                
                {% if file.status == 'segment' %}
                    <span class="badge badge-ready">Seg</span>
                {% else %}
                    <span class="badge badge-new">Crop</span>
                {% endif %}
            </div>
            
            <div class="meta">
                <span title="{{ file.name }}" style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:80px;">{{ file.name }}</span>
                <input type="checkbox" class="select-chk" value="{{ file.name }}" onchange="toggleDeleteBtn()">
            </div>

            <div class="card-actions">
                <a href="/cropper?image={{ file.name }}" class="action-btn action-crop" title="–ö–∞–¥—Ä–∏—Ä–æ–≤–∞—Ç—å">‚úÇÔ∏è Crop</a>
                <a href="/editor?image={{ file.name }}" class="action-btn action-segment" title="–†–∞–∑–º–µ—á–∞—Ç—å">‚úèÔ∏è Seg</a>
                <a href="/text_editor?image={{ file.name }}" class="action-btn" title="–í–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞">üìù Txt</a>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ –ò–º–ø–æ—Ä—Ç–∞ -->
<div id="importModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:999;">
    <div style="background:white; padding:20px; border-radius:8px; width:400px; box-shadow:0 0 10px rgba(0,0,0,0.3);">
        <h3 style="margin-top:0">–ò–º–ø–æ—Ä—Ç –ø—Ä–æ–µ–∫—Ç–∞</h3>
        <input type="file" id="zipInput" accept=".zip" style="width:100%; margin-bottom:15px; border:1px solid #ddd; padding:5px; border-radius:4px;">
        <label style="display:block; margin-bottom:5px;">–£–ø—Ä–æ—â–µ–Ω–∏–µ (px):</label>
        <input type="number" id="simplifyInput" value="5" min="0" style="width:60px; padding:5px; border:1px solid #ddd; border-radius:4px; margin-bottom:20px;">
        <div style="text-align:right;">
            <button class="btn" onclick="closeImportModal()" style="margin-right:10px;">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn btn-primary" onclick="submitZipImport()">–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
    </div>
</div>

<script src="/static/js/api.js"></script>
<script src="/static/js/dashboard.js"></script>
<script>
    // JS —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ (—Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É VSCode)
    function openEditor(name, status) {
        if (status === 'segment') {
            window.location.href = '/editor?image=' + name;
        } else {
            window.location.href = '/cropper?image=' + name;
        }
    }

    function filterTabs(type, tabEl) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tabEl.classList.add('active');
        
        const cards = document.querySelectorAll('.file-card');
        cards.forEach(card => {
            const status = card.getAttribute('data-status');
            if (type === 'all') {
                card.style.display = 'block';
            } else if (type === 'crop') {
                card.style.display = (status === 'crop') ? 'block' : 'none';
            } else if (type === 'segment') {
                card.style.display = (status === 'segment') ? 'block' : 'none';
            }
        });
    }

    const modal = document.getElementById('importModal');
    function openImportModal() { modal.style.display = 'flex'; document.getElementById('zipInput').value = ''; }
    function closeImportModal() { modal.style.display = 'none'; }
    modal.addEventListener('click', e => { if(e.target === modal) closeImportModal(); });
    
    async function submitZipImport() {
        const fileInput = document.getElementById('zipInput');
        const simplifyInput = document.getElementById('simplifyInput');
        if (!fileInput.files.length) return alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª');
        
        const fd = new FormData();
        fd.append('file', fileInput.files[0]);
        fd.append('simplify', simplifyInput.value);
        closeImportModal();
        
        const st = document.getElementById('upload-status');
        if(st) { st.style.display='block'; st.textContent = '–ò–º–ø–æ—Ä—Ç...'; }
        
        try {
            const resp = await fetch('/api/import_zip', {method:'POST', body:fd});
            const d = await resp.json();
            if(d.status === 'success') {
                window.location.reload();
            } else {
                alert('–û—à–∏–±–∫–∞: ' + d.msg);
                if(st) st.style.display='none';
            }
        } catch(e) { alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'); }
    }
</script>
</body>
</html>