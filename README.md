# HTR Polygon Annotation Tool

## Описание проекта

HTR Polygon Annotation Tool - это веб-приложение для подготовки и разметки данных рукописного текста (HTR/OCR). Приложение позволяет выполнять полный цикл подготовки: от кадрирования исходных сканов до точной сегментации строк полигонами и ввода текста.

Проект разработан как часть дипломного проекта и представляет собой легковесное, но функциональное решение для подготовки обучающих данных для систем распознавания рукописного текста.

## Основные возможности

### Подготовка изображений
- **Кадрирование:** Удобное выделение полезной области изображения с возможностью вращения для исправления наклона текста
- **Недеструктивность:** Оригиналы изображений сохраняются автоматически, позволяя переделать обрезку в любой момент
- **Навигация:** Быстрый переход между изображениями

### Разметка
- **Сегментация:** Рисование точных полигонов вокруг строк текста
- **Редактирование:** Перемещение, масштабирование и поточечное редактирование вершин полигона
- **История изменений:** Полноценные Undo / Redo для отмены и повтора действий
- **Визуализация текста:** Отображение текста внутри белых полигонов на правом холсте с возможностью видеть контекст изображения
- **Синхронизация холстов:** Масштаб и положение синхронизируются между левым и правым холстами

### Импорт и экспорт
- **Совместимость с eScriptorium:** Импорт и экспорт ZIP-архивов в формате METS + PageXML (XML-формат для разметки страницы)
- **Упрощение полигонов:** Настройка автоматического упрощения полигонов при импорте

## Технические детали

### Технический стек
- **Backend:** Python 3.10 + Flask
- **Image Processing:** Pillow (PIL)
- **Frontend:** Vanilla JS + Fabric.js (Canvas rendering)
- **Storage:** Локальная файловая система (JSON аннотации + оригиналы изображений)

### Выбор архитектуры фронтенда

После рассмотрения возможностей использования современных фронтенд-фреймворков (React, Vue.js и др.) было принято решение сохранить текущую архитектуру с ванильным JavaScript и Canvas. Основные причины:

1. **Специфика работы с Canvas:** Фреймворки оптимизированы для работы с DOM-элементами, тогда как в проекте используется Canvas для отрисовки геометрических объектов (полигонов), что требует прямого управления пиксельной графикой.

2. **Производительность:** Для работы с большим количеством полигонов и частыми операциями редактирования Canvas показывает лучшую производительность по сравнению с DOM-ориентированными решениями.

3. **Точность геометрических операций:** Canvas с библиотекой Fabric.js предоставляет точные инструменты для работы с геометрическими объектами, что критично для задач разметки текстовых строк.

4. **Избежание конфликта интересов:** Интеграция Canvas с фреймворками может привести к конфликтам между механизмами обновления фреймворка и ручным управлением Canvas.

5. **Простота и контроль:** Ванильный JavaScript дает полный контроль над процессами рендеринга и взаимодействия, что важно для специфических задач проекта.

Хотя фреймворки предлагают преимущества в виде готовых решений и лучшей архитектуры для сложных UI, в данном случае специфика работы с Canvas делает текущий подход более подходящим для задач проекта.

### Структура проекта
```
htr_tool/
├── app.py                # Flask контроллер (роутинг и API endpoints)
├── logic.py              # Бизнес-логика: математика координат, кроп, XML парсинг
├── storage.py            # Работа с файловой системой (CRUD)
├── data/                 # Хранилище данных
│   ├── images/           # Рабочие (обрезанные) изображения
│   ├── originals/        # Бэкапы оригиналов (для повторной обрезки)
│   └── annotations/      # JSON файлы разметки
├── static/
│   ├── css/style.css     # Стили
│   └── js/
│       ├── api.js        # API клиент
│       ├── editor.js     # Логика редактора разметки
│       └── dashboard.js  # Логика главной страницы
└── templates/            # HTML шаблоны
    ├── index.html        # Дашборд
    ├── editor.html       # Редактор сегментации
    └── cropper.html      # Инструмент кадрирования
```

## Установка и запуск

### Python

1. Убедитесь, что у вас установлен Python 3.10+
2. Установите зависимости:
   ```bash
   pip install -r requirements.txt
   ```
3. Запустите приложение:
   ```bash
   python app.py
   ```
4. Откройте браузер и перейдите по адресу: `http://127.0.0.1:5000`

### Docker

```
docker compose up
```

Конфигурация в `docker-compose.yml` уже включает настройки для использования GPU. 

Совместимость версий проверялась на машине: P102-100, Driver version 535.288.01, CUDA 12.2, ubuntu 22.04. 

## Горячие клавиши

### Редактор разметки
| Клавиша | Действие |
| --- | --- |
| **N** | Режим рисования (Draw) |
| **V** | Режим выделения (Select/Edit) |
| **P** | Режим правки точек (Edit Points) |
| **Del** | Удалить выделенное |
| **Esc** | Отмена рисования / Сброс выделения |
| **Ctrl + Z** | Отменить действие (Undo) |
| **Ctrl + Shift + Z** | Вернуть действие (Redo) |
| **Ctrl + A** | Выделить все полигоны |
| **Ctrl + ← / →** | Предыдущее / Следующее изображение |
| **ПКМ** (или Alt+Drag) | Перемещение холста (Pan) |
| **Колесо мыши** | Зум (Zoom) |

## Формат данных

Разметка сохраняется в папку `data/annotations/` в формате JSON. При обрезке добавляется поле `crop_params` для возможности восстановления рамки.

Пример структуры JSON-файла:
```json
{
    "image": "filename.jpg",
    "status": "cropped",
    "crop_params": {
        "x": 100, "y": 100, "w": 500, "h": 800, "angle": 2.5
    },
    "regions": [
        {
            "points": [
                {"x": 100, "y": 100},
                {"x": 200, "y": 100}
            ]
        }
    ]
}
```

## Возможности проекта Yat

### Управление проектами
- **Создание проектов:** Возможность создавать проекты с названием и описанием
- **Организация изображений:** Группировка изображений по проектам
- **Редактирование проектов:** Возможность изменять название и описание проекта
- **Просмотр проектов:** Отображение проектов в виде карточек с информацией о количестве изображений и степени готовности

### Пакетная обработка
- **Пакетная детекция:** Возможность запускать детекцию полигонов для всех изображений в проекте
- **Пакетное распознавание:** Возможность запускать распознавание текста для всех изображений в проекте
- **Мониторинг задач:** Отслеживание прогресса выполнения фоновых задач

### Интерфейс
- **Навигационный заголовок:** Фиксированный заголовок с названием "Yat" и навигационными элементами
- **Просмотр карточек:** Переключение между сеточным и списковым представлением проектов
- **Дедикатные страницы проектов:** Отдельные страницы для каждого проекта с полным функционалом

### Редакторы
- **Редактор обрезки:** Инструмент для кадрирования и вращения изображений
- **Редактор сегментов:** Основной редактор для разметки полигонов
- **Редактор текста:** Инструмент для ввода и редактирования текста, связанного с разметкой
- **Навигация между редакторами:** Удобный переход между редакторами обрезки, сегментов и текста




## Планируемые улучшения

- Активное дообучение модели сегментации
- Модель для определения параметров обрезки
- Возможность экспорта в PDF
- Настройки для распознавателя текста. Несколько режимов чтения: классический, паддинг, скользящее окно.
- Подсистема для сбора эталонных данных, автоматическая оценка относительно них.
- Ленивая инициализация моделей ИИ, выгрузка после окончания работы.
- Добавить поворот картинки как опцию. 
- Использовать vlm для сопоставления картинки и текста (из уже размеченных данных)
- Указать ссылку на модель YOLO

## Известные проблемы

- **Drift bug:** При повторной обрезке уже размеченного изображения, координаты существующих полигонов могут смещаться. Требуется дальнейшее исследование математики пересчета координат при вращении.
- **History bug:** `Ctrl+Z` иногда отменяет несколько действий сразу или вызывает смещение областей при восстановлении состояния.
- **UI:** Иногда при открытии редактора картинка может не прогрузиться с первого раза.
- детекция полигонов запускается для всех а не выбранных
- Нет обработки проектов с одинаковым именем в UI.
- если одна и та же картинка (filename) в нескольких проектах встречается, то прогресс у нее пересекатеся.
- **Проблема с конфигурацией TROCR:** В файле config.py указана одна модель TROCR, но в коде используется другая (русскоязычная версия), что может привести к путанице.