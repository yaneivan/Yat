# Редактор обрезки и логика координат

В системе сосуществуют две папки и один файл описания (JSON) для каждого изображения:

* **Исходные (`data/originals`)**: Неизменяемые оригиналы. Всегда открываются в редакторе обрезки как подложка.
* **Обработанные (`data/images/`)**: Результат обрезки. Именно эти файлы видит нейросеть (YOLO) и редакторы сегментов/текста.
* **Аннотации (`data/annotations/*.json`)**: «Источник истины». Хранит координаты сегментов, распознанный текст и параметры текущей обрезки (`crop_params`).

## 1. Пространства координат

1. **Экран (Viewport)**: Координаты в браузере (зависят от зума и положения камеры).
2. **Мир (World/Image)**: Координаты в пикселях **оригинального** изображения. При сохранении кропа из JS на сервер всегда уходят именно эти координаты.
3. **Локальные (Local)**: Координаты сегментов (строк текста) внутри уже обрезанного изображения.

## 2. Логика пересчета при повторной обрезке

Это самая важная часть системы. Если изображение уже было обрезано и размечено, а пользователь решил **изменить обрезку еще раз**, система выполняет трехэтапный пересчет координат для всех существующих сегментов:

1. **Локальные -> Глобальные**: На основе старых `crop_params` точки переводятся из координат «старого маленького холста» в абсолютные координаты оригинального изображения (через билинейную интерполяцию `lerp_quad`).
2. **Трансформация**: Исходное изображение (`original`) обрезается по новым углам с помощью Pillow `Image.QUAD`.
3. **Глобальные -> Новые локальные**: Точки оригинала проецируются на «новый маленький холст» (через `get_uv`). 

Это позволяет «двигать» рамку обрезки так, чтобы уже нарисованные полигоны строк текста «прилипали» к бумаге и не уплывали при поворотах.

## 3. Сохранность данных (Smart Save)

Все операции в системе (ручное сохранение, обрезка, авторазметка YOLO) работают по принципу **Update, а не Replace**:

* При сохранении любой части данных (только сегменты или только кроп) бэкенд сначала загружает текущий JSON файл.
* Обновляются только пришедшие поля (например, ключ `regions` или `crop_params`).
* Поля, которые не участвуют в текущей операции (например, распознанный текст `texts` при обрезке), **бережно сохраняются**.

## 4. Параметры Pillow QUAD

Для корректной работы трансформации используется метод `Image.QUAD`. 
Порядок передачи углов в Pillow строго определен:
1. `0`: Top-Left (Верхний левый)
2. `1`: Bottom-Left (Нижний левый)
3. `2`: Bottom-Right (Нижний правый)
4. `3`: Top-Right (Верхний правый)

*Примечание: Фронтенд на Fabric.js отправляет углы в порядке обхода по часовой стрелке (TL, TR, BR, BL), поэтому на бэкенде в `perform_crop` индексы 1 и 3 меняются местами для соответствия спецификации Pillow.*
